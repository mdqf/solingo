{% extends "base.html" %}

{% block title %}شروع جلسه یادگیری - Solingo{% endblock %}

{% block extra_css %}
<style>
    .session-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .session-card {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .session-header {
        background: linear-gradient(135deg, #4a6fa5, #6c8bc7);
        color: white;
        padding: 40px 30px;
        text-align: center;
    }
    
    .session-type-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .session-type-card:hover {
        border-color: #4a6fa5;
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(74, 111, 165, 0.1);
    }
    
    .session-type-card.selected {
        border-color: #4a6fa5;
        background-color: rgba(74, 111, 165, 0.05);
    }
    
    .session-icon {
        font-size: 3rem;
        margin-bottom: 20px;
    }
    
    .stats-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
</style>
{% endblock %}

{% block content %}
<div class="session-container">
    <!-- هدر -->
    <div class="session-header rounded-3 mb-4">
        <h1 class="display-5 mb-3">
            <i class="bi bi-play-circle me-2"></i>شروع جلسه یادگیری
        </h1>
        <p class="lead mb-0">نوع جلسه مورد نظر خود را انتخاب کنید</p>
    </div>

    <!-- کارت آمار -->
    <div class="stats-card">
        <div class="row text-center">
            <div class="col-md-3 col-6 mb-3">
                <div class="h4 text-primary" id="dueCount">0</div>
                <small class="text-muted">برای مرور</small>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="h4 text-success" id="newCount">0</div>
                <small class="text-muted">کلمه جدید</small>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="h4 text-info" id="streakCount">0</div>
                <small class="text-muted">روز متوالی</small>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="h4 text-warning" id="accuracy">0%</div>
                <small class="text-muted">میانگین دقت</small>
            </div>
        </div>
    </div>

    <!-- انواع جلسات -->
    <div class="row g-4 mb-5">
        <!-- جلسه سریع -->
        <div class="col-md-4">
            <div class="session-type-card" data-type="quick">
                <div class="session-icon text-primary">
                    <i class="bi bi-lightning"></i>
                </div>
                <h4>مرور سریع</h4>
                <p class="text-muted">۵ کلمه از کلمات نیازمند مرور</p>
                <div class="mt-3">
                    <span class="badge bg-primary">۵ دقیقه</span>
                </div>
            </div>
        </div>
        
        <!-- جلسه استاندارد -->
        <div class="col-md-4">
            <div class="session-type-card selected" data-type="standard">
                <div class="session-icon text-success">
                    <i class="bi bi-play-circle"></i>
                </div>
                <h4>جلسه استاندارد</h4>
                <p class="text-muted">۱۰ کلمه (ترکیب جدید و مروری)</p>
                <div class="mt-3">
                    <span class="badge bg-success">۱۰-۱۵ دقیقه</span>
                </div>
            </div>
        </div>
        
        <!-- جلسه تمرین -->
        <div class="col-md-4">
            <div class="session-type-card" data-type="practice">
                <div class="session-icon text-warning">
                    <i class="bi bi-bar-chart"></i>
                </div>
                <h4>تمرین کلمات ضعیف</h4>
                <p class="text-muted">تمرین روی کلمات نیازمند تمرین بیشتر</p>
                <div class="mt-3">
                    <span class="badge bg-warning">متمرکز</span>
                </div>
            </div>
        </div>
    </div>

    <!-- تنظیمات جلسه -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-gear me-2"></i>تنظیمات جلسه
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- تعداد کلمات -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">تعداد کلمات</label>
                    <select class="form-select" id="wordCount">
                        <option value="5">۵ کلمه</option>
                        <option value="10" selected>۱۰ کلمه</option>
                        <option value="15">۱۵ کلمه</option>
                        <option value="20">۲۰ کلمه</option>
                    </select>
                </div>
                
                <!-- تمرکز روی -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">تمرکز روی</label>
                    <select class="form-select" id="focusType">
                        <option value="mixed" selected>ترکیب کلمات جدید و مروری</option>
                        <option value="new">فقط کلمات جدید</option>
                        <option value="review">فقط مرور کلمات قدیمی</option>
                        <option value="weak">کلمات ضعیف</option>
                    </select>
                </div>
            </div>
            
            <!-- تنظیمات پیشرفته -->
            <div class="accordion" id="advancedSettings">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#settingsCollapse">
                            <i class="bi bi-sliders me-2"></i>تنظیمات پیشرفته
                        </button>
                    </h2>
                    <div id="settingsCollapse" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">سطح دشواری</label>
                                    <select class="form-select" id="difficulty">
                                        <option value="easy">آسان</option>
                                        <option value="medium" selected>متوسط</option>
                                        <option value="hard">سخت</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">انواع تمرین</label>
                                    <select class="form-select" id="exerciseTypes" multiple>
                                        <option value="multiple_choice" selected>چندگزینه‌ای</option>
                                        <option value="typing" selected>تایپینگ</option>
                                        <option value="article_choice">انتخاب مقاله</option>
                                        <option value="sentence_completion">تکمیل جمله</option>
                                    </select>
                                    <small class="text-muted">Ctrl+Click برای انتخاب چندگزینه</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- دکمه شروع -->
    <div class="text-center">
        <button class="btn btn-primary btn-lg px-5 py-3" id="startSessionBtn">
            <i class="bi bi-play-fill me-2"></i>شروع جلسه
        </button>
        <a href="{{ url_for('learning.dashboard') }}" class="btn btn-outline-secondary btn-lg px-5 py-3 ms-3">
            <i class="bi bi-x-circle me-2"></i>انصراف
        </a>
    </div>
</div>

<!-- مودال در حال آماده‌سازی -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
                <h4 class="mb-3">در حال آماده‌سازی جلسه...</h4>
                <p class="text-muted" id="loadingMessage">لطفاً چند لحظه صبر کنید</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال خطا -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>خطا
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="bi bi-emoji-frown display-1 text-danger mb-3"></i>
                <h4 id="errorTitle">خطا در شروع جلسه</h4>
                <p class="lead" id="errorMessage"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    فهمیدم
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedSessionType = 'standard';

$(document).ready(function() {
    // بارگذاری آمار اولیه
    loadSessionStats();
    
    // انتخاب نوع جلسه
    $('.session-type-card').click(function() {
        $('.session-type-card').removeClass('selected');
        $(this).addClass('selected');
        selectedSessionType = $(this).data('type');
    });
    
    // دکمه شروع جلسه
    $('#startSessionBtn').click(startLearningSession);
    
    // تغییر تنظیمات بر اساس نوع جلسه
    $('.session-type-card').click(updateSettingsBasedOnType);
    
    // بارگذاری اولیه تنظیمات
    updateSettingsBasedOnType();
});

function loadSessionStats() {
    $.ajax({
        url: "{{ url_for('learning.session_stats') }}",
        type: 'GET',
        success: function(stats) {
            updateStatsDisplay(stats);
        }
    });
    
    // بارگذاری آمار کلمات
    $.ajax({
        url: "{{ url_for('learning.dashboard') }}?json=1",
        type: 'GET',
        success: function(data) {
            $('#dueCount').text(data.due_words || 0);
            $('#streakCount').text("{{ current_user.streak_days }}" || 0);
        }
    });
}

function updateStatsDisplay(stats) {
    // این تابع می‌تواند آمارهای اضافی را نمایش دهد
}

function updateSettingsBasedOnType() {
    const type = selectedSessionType;
    
    switch(type) {
        case 'quick':
            $('#wordCount').val('5');
            $('#focusType').val('review');
            break;
            
        case 'standard':
            $('#wordCount').val('10');
            $('#focusType').val('mixed');
            break;
            
        case 'practice':
            $('#wordCount').val('15');
            $('#focusType').val('weak');
            break;
    }
}

function startLearningSession() {
    // ذخیره نوع جلسه در sessionStorage
    if (selectedSessionType === 'practice') {
        sessionStorage.setItem('is_practice', 'true');
    } else {
        sessionStorage.removeItem('is_practice');
    }    // جمع‌آوری تنظیمات
    
    const settings = {
        type: selectedSessionType,
        word_count: $('#wordCount').val(),
        focus_type: $('#focusType').val(),
        difficulty: $('#difficulty').val(),
        exercise_types: $('#exerciseTypes').val() || ['multiple_choice', 'typing']
    };
    
    // نمایش مودال در حال آماده‌سازی
    showLoadingModal('در حال آماده‌سازی جلسه یادگیری...');
    
    // درخواست شروع جلسه
    $.ajax({
        url: "{{ url_for('learning.api_start_session') }}",
        type: 'GET',
        data: settings,
        success: function(response) {
            if (response.success) {
                // هدایت به صفحه تمرین
                setTimeout(() => {
                    window.location.href = "{{ url_for('learning.advanced_review') }}";
                }, 1000);
            } else {
                // نمایش خطا
                hideLoadingModal();
                showErrorModal(response.message || 'خطا در شروع جلسه');
            }
        },
        error: function(xhr, status, error) {
            hideLoadingModal();
            showErrorModal('خطا در ارتباط با سرور. لطفاً دوباره تلاش کنید.');
        }
    });
}

function showLoadingModal(message) {
    if (message) {
        $('#loadingMessage').text(message);
    }
    $('#loadingModal').modal('show');
}

function hideLoadingModal() {
    $('#loadingModal').modal('hide');
}

function showErrorModal(message) {
    $('#errorMessage').text(message);
    $('#errorModal').modal('show');
}
</script>
{% endblock %}